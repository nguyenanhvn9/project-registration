<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Form Đăng ký Đề tài</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .student-entry:not(:first-child) { margin-top: 1rem; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex items-center justify-center min-h-screen py-8">

    <div class="container mx-auto p-4 md:p-8 max-w-2xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-blue-600">Form Đăng ký Đề tài Sinh viên</h1>
            <p class="text-gray-600 mt-2">Điền thông tin nhóm và đề tài của bạn vào form bên dưới</p>
        </header>

        <!-- Wrapper cho Form và Kết quả -->
        <div id="form-wrapper" class="bg-white p-6 md:p-8 rounded-xl shadow-lg">
            <form id="registrationForm">
                <!-- Vùng nhập thông tin sinh viên -->
                <div id="student-list" class="space-y-4">
                    <h3 class="text-lg font-semibold text-gray-800 border-b pb-2">Thông tin Nhóm</h3>
                    <!-- Sinh viên đầu tiên (mặc định) -->
                    <div class="student-entry p-4 border rounded-lg bg-gray-50">
                        <p class="font-medium text-gray-700 mb-2">Thành viên 1 (Nhóm trưởng)</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Mã số Sinh viên</label>
                                <input type="text" name="student_id" placeholder="Nhập MSSV" required class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 transition">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Họ và Tên</label>
                                <input type="text" name="student_name" placeholder="Nhập Họ và Tên" required class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 transition">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Nút thêm sinh viên -->
                <div class="mt-4">
                    <button type="button" id="addStudentBtn" class="w-full bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 transition">
                        + Thêm Thành viên
                    </button>
                </div>
                
                <!-- Vùng nhập tên đề tài -->
                <div class="mt-6 pt-6 border-t">
                     <h3 class="text-lg font-semibold text-gray-800 mb-2">Thông tin Đề tài</h3>
                    <div>
                        <label for="project_title" class="block text-sm font-medium text-gray-700">Tên Đề tài</label>
                        <textarea id="project_title" rows="4" placeholder="Nhập tên đề tài chi tiết của nhóm..." required class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 transition"></textarea>
                    </div>
                </div>

                <!-- Nút submit -->
                <button type="submit" id="submitBtn" class="mt-8 w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-transform transform hover:scale-105">
                    Hoàn tất Đăng ký
                </button>
                <div id="formMessage" class="mt-4 text-center font-medium"></div>
            </form>
        </div>
        
        <!-- Vùng hiển thị kết quả sau khi đăng ký thành công -->
        <div id="result-wrapper" class="hidden bg-white p-6 md:p-8 rounded-xl shadow-lg">
            <!-- Nội dung kết quả sẽ được chèn vào đây -->
        </div>


        <footer class="text-center mt-12 text-gray-500 text-sm">
            <p>Phát triển bởi Gemini &copy; <span id="year"></span></p>
        </footer>
    </div>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // =================================================================================
        // BƯỚC 1: DÁN CẤU HÌNH FIREBASE CỦA BẠN VÀO ĐÂY
        // =================================================================================
        const firebaseConfig = {
        apiKey: "AIzaSyDHfAxx8iTGGDZVDu5OGJq-Ar_rpxAXb4Y",
        authDomain: "j2ee-application-development.firebaseapp.com",
        projectId: "j2ee-application-development",
        storageBucket: "j2ee-application-development.firebasestorage.app",
        messagingSenderId: "54577590552",
        appId: "1:54577590552:web:5d3857319b5327a0a46e6d",
        measurementId: "G-EZ3QEE1QR6"
        };
        // =================================================================================

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const form = document.getElementById('registrationForm');
        const submitBtn = document.getElementById('submitBtn');
        const formMessage = document.getElementById('formMessage');
        const studentListDiv = document.getElementById('student-list');
        const addStudentBtn = document.getElementById('addStudentBtn');
        const formWrapper = document.getElementById('form-wrapper');
        const resultWrapper = document.getElementById('result-wrapper');
        
        document.getElementById('year').textContent = new Date().getFullYear();

        let studentCount = 1;

        // HÀM RESET FORM VỀ TRẠNG THÁI BAN ĐẦU
        function resetFormState() {
            form.reset();
            studentListDiv.innerHTML = `
                <h3 class="text-lg font-semibold text-gray-800 border-b pb-2">Thông tin Nhóm</h3>
                <div class="student-entry p-4 border rounded-lg bg-gray-50">
                    <p class="font-medium text-gray-700 mb-2">Thành viên 1 (Nhóm trưởng)</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Mã số Sinh viên</label>
                            <input type="text" name="student_id" placeholder="Nhập MSSV" required class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 transition">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Họ và Tên</label>
                            <input type="text" name="student_name" placeholder="Nhập Họ và Tên" required class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 transition">
                        </div>
                    </div>
                </div>
            `;
            studentCount = 1;
            formMessage.textContent = '';
        }

        // HÀM THÊM TRƯỜNG NHẬP LIỆU CHO SINH VIÊN MỚI
        addStudentBtn.addEventListener('click', () => {
            studentCount++;
            const newStudentEntry = document.createElement('div');
            newStudentEntry.className = 'student-entry p-4 border rounded-lg bg-gray-50 relative';
            newStudentEntry.innerHTML = `
                <p class="font-medium text-gray-700 mb-2">Thành viên ${studentCount}</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Mã số Sinh viên</label>
                        <input type="text" name="student_id" placeholder="Nhập MSSV" required class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 transition">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Họ và Tên</label>
                        <input type="text" name="student_name" placeholder="Nhập Họ và Tên" required class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 transition">
                    </div>
                </div>
                <button type="button" class="remove-student-btn absolute top-2 right-2 text-red-500 hover:text-red-700 font-bold text-xl">&times;</button>
            `;
            studentListDiv.appendChild(newStudentEntry);
        });

        // HÀM XÓA MỘT THÀNH VIÊN
        studentListDiv.addEventListener('click', (e) => {
            if (e.target.classList.contains('remove-student-btn')) {
                e.target.closest('.student-entry').remove();
                const remainingStudents = studentListDiv.querySelectorAll('.student-entry');
                studentCount = remainingStudents.length;
                remainingStudents.forEach((student, index) => {
                    const title = student.querySelector('p');
                    title.textContent = `Thành viên ${index + 1}${index === 0 ? ' (Nhóm trưởng)' : ''}`;
                });
            }
        });

        // HÀM GỬI DỮ LIỆU LÊN FIRESTORE
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            submitBtn.disabled = true;
            submitBtn.textContent = 'Đang xử lý...';
            formMessage.textContent = '';

            const studentEntries = document.querySelectorAll('.student-entry');
            const students = [];
            studentEntries.forEach(entry => {
                const id = entry.querySelector('input[name="student_id"]').value;
                const name = entry.querySelector('input[name="student_name"]').value;
                students.push({ id, name });
            });

            const project_title = form.project_title.value;

            try {
                await addDoc(collection(db, "projects"), {
                    students: students,
                    project_title: project_title,
                    registration_time: new Date()
                });
                
                // HIỂN THỊ KẾT QUẢ
                let studentRows = students.map((student, index) => `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="p-3 text-center">${index + 1}</td>
                        <td class="p-3">${student.id}</td>
                        <td class="p-3">${student.name}</td>
                        <td class="p-3">${index === 0 ? '<strong>Nhóm trưởng</strong>' : ''}</td>
                    </tr>
                `).join('');

                resultWrapper.innerHTML = `
                    <h2 class="text-2xl font-bold text-green-600 text-center mb-6">✅ Đăng ký Thành Công!</h2>
                    <div class="space-y-4">
                        <div>
                            <h3 class="font-semibold text-lg">Tên đề tài:</h3>
                            <p class="mt-1 p-3 bg-gray-100 rounded-md">${project_title}</p>
                        </div>
                        <div>
                            <h3 class="font-semibold text-lg">Danh sách thành viên:</h3>
                            <div class="mt-1 overflow-x-auto">
                                <table class="w-full min-w-full text-left border-collapse">
                                    <thead class="bg-gray-200">
                                        <tr>
                                            <th class="p-3 text-sm font-semibold tracking-wide text-center">STT</th>
                                            <th class="p-3 text-sm font-semibold tracking-wide">Mã Sinh viên</th>
                                            <th class="p-3 text-sm font-semibold tracking-wide">Họ và Tên</th>
                                            <th class="p-3 text-sm font-semibold tracking-wide">Ghi chú</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-200">${studentRows}</tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <button type="button" id="registerAgainBtn" class="mt-8 w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition">
                        Đăng ký Nhóm Khác
                    </button>
                `;
                
                formWrapper.classList.add('hidden');
                resultWrapper.classList.remove('hidden');

                resetFormState();

            } catch (error) {
                console.error("Error adding document: ", error);
                formMessage.textContent = '❌ Có lỗi xảy ra, vui lòng thử lại.';
                formMessage.className = 'mt-4 text-center font-medium text-red-600';
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Hoàn tất Đăng ký';
            }
        });

        // LẮNG NGHE SỰ KIỆN CHO NÚT "ĐĂNG KÝ NHÓM KHÁC"
        resultWrapper.addEventListener('click', (e) => {
            if (e.target && e.target.id === 'registerAgainBtn') {
                resultWrapper.classList.add('hidden');
                formWrapper.classList.remove('hidden');
            }
        });

    </script>
</body>
</html>
